<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Chat Online</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        /* --- LAYOUT SETUP --- */
        body, html {
            height: 100%;
            margin: 0;
            overflow: hidden; /* Prevent body scroll, handle inside divs */
            background-color: #f0f2f5;
        }

        .main-row {
            height: 100vh;

        }

        /* --- SCROLLBAR HIDING (Cross Browser) --- */
        .hide-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        /* --- SIDEBAR STYLES --- */
        .sidebar {
            background-color: white;
            border-right: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 0;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .chat-list {
            flex-grow: 1;
            overflow-y: auto;
        }

        .conversation-item {
            border: none;
            border-bottom: 1px solid #f8f9fa;
            cursor: pointer;
            transition: background 0.2s;
            padding: 15px 20px;
        }

        .conversation-item:hover {
            background-color: #f5f5f5;
        }

        .conversation-item.active {
            background-color: #e7f1ff;
            border-left: 4px solid #0d6efd;
        }

        .avatar-img {
            width: 45px;
            height: 45px;
            object-fit: cover;
            border-radius: 50%;
            border: 1px solid #dee2e6;
        }

        /* --- CHAT AREA STYLES --- */
        .chat-area {
            display: flex;
            flex-direction: column;
            height: 100%;
            background-color: #efeae2; /* WhatsApp-like generic bg */
            /* background-image: url('path-to-pattern.png'); Optional */
        }

        .chat-header {
            background-color: white;
            padding: 10px 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            height: 60px;
        }

        .messages-box {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* Pushes messages to bottom if there are few */
        .messages-box > :first-child {
            margin-top: auto;
        }

        .chat-footer {
            background-color: #f0f0f0;
            padding: 10px 20px;
            height: 70px;
            display: flex;
            align-items: center;
        }

        /* --- MESSAGE BUBBLES --- */
        .message-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 8px;
            max-width: 70%;
        }

        /* RECEIVED (Left) */
        .message-received {
            align-self: flex-start;
            align-items: flex-start;
        }
        .message-received .msg-bubble {
            background-color: white;
            color: #303030;
            border-radius: 0 12px 12px 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* SENT (Right) */
        .message-sent {
            align-self: flex-end;
            align-items: flex-end;
        }
        .message-sent .msg-bubble {
            background-color: #d9fdd3; /* Light Green */
            color: black;
            border-radius: 12px 0 12px 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .msg-bubble {
            padding: 8px 12px;
            position: relative;
            word-wrap: break-word;
            font-size: 0.95rem;
        }

        .sender-name {
            font-size: 0.75rem;
            color: #d63384; /* Distinct color for names */
            margin-bottom: 2px;
            margin-left: 2px;
            font-weight: 600;
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row main-row">

        <!-- ================= SIDEBAR ================= -->
        <div class="col-md-4 col-lg-3 sidebar">

            <!-- HEADER -->
            <div class="sidebar-header d-flex justify-content-between align-items-center">

                <a href="/" class="btn btn-light btn-sm rounded-circle" title="Chats">
                    <h4 class="mb-0 fw-bold text-primary">Chats</h4>
                </a>
                <div class="btn-group">
                    <a href="/profile" class="btn btn-light btn-sm rounded-circle" title="Settings">
                        <i class="bi bi-gear-fill text-secondary"></i>
                    </a>
                    <form th:action="@{/logout}" method="post" class="d-inline ms-1">
                        <button type="submit" class="btn btn-light btn-sm rounded-circle" title="Logout">
                            <i class="bi bi-box-arrow-right text-danger"></i>
                        </button>
                    </form>
                </div>
            </div>

            <!-- SEARCH (Visual Only) -->
            <div class="p-2">
                <input type="text" class="form-control form-control-sm bg-light border-0" placeholder="Search or start new chat">
            </div>

            <!-- CONVERSATION LIST -->
            <div class="chat-list hide-scrollbar">
                <a th:each="chat : ${conversations}"
                   th:href="@{/chats/{id}(id=${chat.id})}"
                   th:attr="data-conversation-id=${chat.id}"
                   class="list-group-item list-group-item-action conversation-item"
                   th:classappend="${chat.active} ? 'active' : ''">

                    <div class="d-flex align-items-center">
                        <!-- Avatar -->
                        <div class="position-relative">
                            <img th:src="${chat.conversationPicture}" alt="Avatar" class="avatar-img">
                        </div>

                        <!-- Text Info -->
                        <div class="ms-3 overflow-hidden w-100">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 text-truncate" th:text="${chat.conversationName}">User Name</h6>
                                <!-- Optional: You can add time here if you have it in DTO -->
                                <!-- <small class="text-muted" style="font-size: 0.7rem;">12:30</small> -->
                            </div>
                            <small class="text-muted text-truncate d-block last-message" th:text="${chat.lastMessage}">
                                Last message content...
                            </small>
                        </div>
                    </div>
                </a>
            </div>
        </div>

        <!-- ================= MAIN CHAT AREA ================= -->
        <div class="col-md-8 col-lg-9 p-0">

            <!-- SCENARIO A: NO CHAT SELECTED -->
            <div th:if="${activeConversation == null}" class="d-flex flex-column justify-content-center align-items-center h-100" style="background-color: #f0f2f5;">
                <div class="text-center p-5">
                    <i class="bi bi-chat-heart text-secondary" style="font-size: 5rem;"></i>
                    <h2 class="mt-4 text-secondary">Welcome, <span th:text="${username}">User</span>!</h2>
                    <p class="text-muted lead">Select a chat to start messaging.</p>
                </div>
            </div>

            <!-- SCENARIO B: ACTIVE CHAT -->
            <div th:if="${activeConversation != null}" class="chat-area">

                <!-- 1. CHAT HEADER -->
                <div class="chat-header shadow-sm">

                    <!-- WRAP IN LINK -->
                    <a th:href="@{/profile/users/{username}(username=${activeConversation.getTargetUsername()})}"
                       class="d-flex align-items-center text-decoration-none text-dark">

                        <!-- Avatar -->
                        <img th:src="${activeConversation.getConversationPicture()}"
                             class="rounded-circle me-2 border"
                             style="width: 40px; height: 40px; object-fit: cover;"
                             alt="Avatar">

                        <!-- Name -->
                        <div>
                            <h6 class="mb-0" th:text="${activeConversation.getTargetUsername()}">Chat Name</h6>
                            <small class="text-muted">View Profile</small>
                        </div>
                    </a>

                </div>

                <!-- 2. MESSAGES FEED -->
                <div id="messageArea" class="messages-box hide-scrollbar">

                    <!-- Loop History -->
                    <div th:each="msg : ${chatHistory}"
                         class="message-container"
                         th:classappend="${msg.senderUsername == username} ? 'message-sent' : 'message-received'">

                        <!-- Sender Name (Only for received messages) -->
                        <span class="sender-name"
                              th:if="${msg.senderUsername != username}"
                              th:text="${msg.senderUsername}">Name</span>

                        <!-- Bubble -->
                        <div class="msg-bubble">
                            <span th:text="${msg.content}">Message Content</span>
                            <!-- Time (Optional) -->
                            <!-- <span class="text-muted ms-2" style="font-size:0.65rem; float:right; margin-top:5px;">10:00</span> -->
                        </div>
                    </div>

                </div>

                <!-- 3. INPUT FOOTER -->
                <div class="chat-footer">
                    <div class="input-group">
                        <button class="btn btn-light text-secondary" type="button"><i class="bi bi-emoji-smile"></i></button>
                        <button class="btn btn-light text-secondary" type="button"><i class="bi bi-paperclip"></i></button>

                        <input type="text" id="messageInput" class="form-control border-0 bg-white" placeholder="Type a message..." autocomplete="off">

                        <button class="btn btn-primary" onclick="sendMessage()">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- HIDDEN DATA FOR JS -->
<input type="hidden" id="currentConversationId"
       th:value="${activeConversation != null ? activeConversation.getId() : ''}">

<input type="hidden" id="currentUsername" th:value="${username}">

<!-- SCRIPTS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    var stompClient = null;
    var conversationId = document.getElementById("currentConversationId").value;
    var username = document.getElementById("currentUsername").value;
    var messageArea = document.getElementById("messageArea");
    var messageInput = document.getElementById("messageInput");

    // --- INITIALIZATION ---
    document.addEventListener("DOMContentLoaded", function() {
        // 1. Scroll to bottom
        scrollToBottom();

        // 2. Connect WebSocket
        if (conversationId) {
            connect();
        }

        // 3. Enter Key Listener
        if (messageInput) {
            messageInput.addEventListener("keypress", function(event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    sendMessage();
                }
            });
        }
    });

    // --- WEBSOCKET CONNECTION ---
    function connect() {
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.debug = null; // Disable debug logs

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/conversation/' + conversationId, function (result) {
                showIncomingMessage(JSON.parse(result.body));
            });
        });
    }

    // --- SEND MESSAGE ---
    function sendMessage() {
        var content = messageInput.value.trim();
        if(content && stompClient) {
            var chatMessage = {
                content: content,
                conversationId: conversationId
            };
            stompClient.send("/app/conversation/" + conversationId + "/sendMessage", {}, JSON.stringify(chatMessage));
            messageInput.value = ''; // Clear input
            messageInput.focus();
        }
    }

    // --- DISPLAY MESSAGE ---
    function showIncomingMessage(message) {
        if (!messageArea) return;

        var div = document.createElement('div');
        var isMe = (message.senderUsername === username);

        // Add Classes
        div.classList.add('message-container');
        div.classList.add(isMe ? 'message-sent' : 'message-received');

        // Build Name HTML (Only for others)
        var nameHtml = !isMe ? `<span class="sender-name">${message.senderUsername}</span>` : '';

        // Build Bubble HTML
        div.innerHTML = `
            ${nameHtml}
            <div class="msg-bubble">
                <span>${message.content}</span>
            </div>
        `;

        messageArea.appendChild(div);
        scrollToBottom();
        updateSidebarPreview(message);
    }

    // --- HELPERS ---
    function scrollToBottom() {
        if (messageArea) {
            messageArea.scrollTop = messageArea.scrollHeight;
        }
    }

    function updateSidebarPreview(message) {
        // Find chat in sidebar
        var chatItem = document.querySelector(`[data-conversation-id="${message.conversationId}"]`);
        if (chatItem) {
            var preview = chatItem.querySelector('.last-message');
            if (preview) {
                var prefix = (message.senderUsername === username) ? "You: " : "";
                preview.innerText = prefix + message.content;
            }
            // Move to top
            chatItem.parentElement.prepend(chatItem);
            // Highlight
            chatItem.classList.add("fw-bold");
            setTimeout(() => chatItem.classList.remove("fw-bold"), 2000);
        }
    }
</script>

</body>
</html>