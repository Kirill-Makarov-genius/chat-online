<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> <!-- UPDATED: Запрет зума -->
    <title>Messenger | Chat Online</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-body: #080c14;
            --sidebar-bg: rgba(30, 41, 59, 0.9);
            --chat-bg: #0f172a;
            --glass-border: rgba(255, 255, 255, 0.12);
            --accent: #38bdf8;
            --msg-sent: rgba(56, 189, 248, 0.2);
            --msg-received: rgba(255, 255, 255, 0.08);
            --text-main: #f8fafc;
            --text-muted: #feffffbf
        }

        html, body {
            height: 100dvh;
            width: 100%; /* ИЗМЕНЕНО: 100vw часто вызывает прокрутку, 100% безопаснее */
            max-width: 100%; /* Страховка */
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden; /* Скрывает скролл глобально */
            overflow-x: hidden; /* ИЗМЕНЕНО: Жестко запрещаем горизонтальный скролл */
            background-color: var(--bg-body);
            font-family: 'Inter', sans-serif;
            color: var(--text-main);
            position: relative; /* Фикс для некоторых мобильных браузеров */
        }

        .main-row {
            height: 100dvh;
            width: 100%;
            margin: 0 !important;
            padding: 0 !important;
            overflow-x: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            height: 100dvh;
            display: flex;
            flex-direction: column;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--glass-border);
            padding: 0 !important;
            z-index: 10;
        }

        .sidebar-header {
            padding: 20px;
            height: 75px; /* Фиксированная высота */
            flex-shrink: 0; /* Не сжимать */
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-list {
            flex-grow: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* Плавный скролл на iOS */
        }

        .conversation-item {
            padding: 15px 20px;
            margin: 4px 10px;
            border-radius: 12px;
            transition: 0.2s;
            color: var(--text-muted);
            text-decoration: none;
            display: block;
        }
        .conversation-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .conversation-item.active {
            background: var(--msg-sent);
            color: var(--accent);
            border-left: 3px solid var(--accent);
        }

        /* --- CHAT AREA --- */
        .chat-column {
            height: 100dvh;
            padding: 0 !important;
            background: var(--chat-bg);
            /* На мобильных это будет перекрывать сайдбар, если активно */
        }

        .chat-area {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: radial-gradient(circle at center, #1e293b, var(--bg-body));
        }

        .chat-header {
            height: 75px;
            flex-shrink: 0; /* Не сжимать при открытии клавиатуры */
            background: rgba(30, 41, 59, 0.95); /* Чуть плотнее фон */
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
            padding: 0 15px; /* Чуть меньше отступы для мобилок */
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 20;
        }

        .messages-box {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            -webkit-overflow-scrolling: touch;
            /* Важно для прокрутки под клавиатурой */
            scroll-behavior: smooth;
        }

        /* Сообщения */
        .message-container { max-width: 85%; margin-bottom: 12px; display: flex; flex-direction: column; }
        .message-sent { align-self: flex-end; align-items: flex-end; }
        .message-received { align-self: flex-start; align-items: flex-start; }

        .msg-bubble {
            padding: 10px 14px;
            border-radius: 18px;
            border: 1px solid var(--glass-border);
            font-size: 0.95rem;
            line-height: 1.4;
            word-wrap: break-word;
            word-break: break-word; /* ДОБАВЛЕНО: Ломает длинные слова/ссылки */
            max-width: 100%; /* Страховка */
        }
        .message-sent .msg-bubble { background: var(--msg-sent); color: #fff; border-bottom-right-radius: 4px; }
        .message-received .msg-bubble { background: var(--msg-received); color: #fff; border-bottom-left-radius: 4px; }

        .msg-time { font-size: 0.65rem; margin-top: 4px; color: var(--text-muted); }

        /* --- FOOTER & INPUT --- */
        .chat-footer {
            padding: 10px 15px;
            background: rgba(30, 41, 59, 1); /* Непрозрачный фон, чтобы не просвечивали сообщения */
            border-top: 1px solid var(--glass-border);
            flex-shrink: 0; /* Не сжимать footer */
            /* UPDATED: Фикс для iOS Safari (safe area) */
            padding-bottom: env(safe-area-inset-bottom, 15px);
        }

        .input-group-custom {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 4px 12px;
            display: flex;
            align-items: center;
        }

        .chat-input {
            background: transparent !important;
            border: none !important;
            color: var(--text-main) !important;
            font-size: 1rem;
            box-shadow: none !important;
            height: 40px; /* Фиксированная высота */
        }
        .chat-input::placeholder { color: var(--text-muted); opacity: 0.7; }
        .chat-input:focus { outline: none; }

        /* Кнопки и утилиты */
        .btn-logout {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.15);
        }
        .avatar-img { width: 40px; height: 40px; border-radius: 12px; object-fit: cover; border: 1px solid var(--glass-border); }

        /* --- UPDATED: MOBILE LOGIC --- */
        /* Показываем кнопку "Назад" только на мобильных */
        .mobile-back-btn { display: none; }

        @media (max-width: 767.98px) {
            .mobile-back-btn { display: block; margin-right: 10px; color: var(--text-main); font-size: 1.2rem; }

            /* Если чат не выбран, скрываем колонку чата на мобильных */
            .show-sidebar-only .chat-column { display: none !important; }
            .show-sidebar-only .sidebar { display: flex !important; width: 100%; }

            /* Если чат выбран, скрываем сайдбар на мобильных */
            .show-chat-only .sidebar { display: none !important; }
            .show-chat-only .chat-column { display: flex !important; width: 100%; }

            /* Скрываем кнопку Watch Together на очень узких экранах, оставляя иконку */
            .watch-btn-text { display: none; }
        }
    </style>
</head>
<body>

<div class="container-fluid p-0 m-0 overflow-hidden">
    <!-- UPDATED: Добавляем классы логики отображения в зависимости от activeConversation -->
    <div class="row main-row g-0"
         th:classappend="${activeConversation != null} ? 'show-chat-only' : 'show-sidebar-only'">

        <!-- ================= SIDEBAR ================= -->
        <!-- Добавляем col-12 для мобильных -->
        <div class="col-12 col-md-4 col-lg-3 sidebar">
            <div class="sidebar-header">
                <a href="/" class="text-decoration-none"><h5 class="mb-0 fw-bold text-white">Chats</h5></a>
                <div class="d-flex align-items-center gap-2">
                    <!-- Уведомления и кнопки (без изменений) -->
                    <div class="dropdown">
                        <button class="btn btn-dark btn-sm rounded-3 border-secondary" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-bell text-info"></i>
                            <span id="notificationBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none; font-size: 0.6rem;">0</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow bg-dark border-secondary" id="notificationList" style="width: 280px;">
                            <li><h6 class="dropdown-header text-muted">Notifications</h6></li>
                            <li id="no-notif-msg" class="text-center p-3 text-muted small">No new messages</li>
                        </ul>
                    </div>
                    <a href="/profile" class="btn btn-dark btn-sm rounded-3 border-secondary"><i class="bi bi-gear"></i></a>
                    <a href="/watch/manage" class="btn btn-dark btn-sm rounded-3 border-secondary"><i class="bi bi-collection-play text-warning"></i></a>
                    <form th:action="@{/logout}" method="post" class="m-0">
                        <button type="submit" class="btn btn-logout btn-sm rounded-3"><i class="bi bi-box-arrow-right"></i></button>
                    </form>
                </div>
            </div>

            <div class="p-3">
                <form action="/chats/open" method="post" class="input-group-custom">
                    <i class="bi bi-search text-info me-2"></i>
                    <input type="text" name="targetUsername" class="form-control chat-input" placeholder="Search..." required>
                </form>
            </div>

            <div class="chat-list">
                <a th:each="chat : ${conversations}" th:href="@{/chats/{id}(id=${chat.id})}" th:attr="data-conversation-id=${chat.id}" class="conversation-item" th:classappend="${chat.active} ? 'active' : ''">
                    <div class="d-flex align-items-center">
                        <img th:src="${chat.conversationPicture}" class="avatar-img me-3">
                        <div class="overflow-hidden w-100">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="fw-bold text-truncate text-white" th:text="${chat.conversationName}">Name</span>
                                <small class="text-info" style="font-size: 0.5rem;">●</small>
                            </div>
                            <small class="text-truncate d-block" style="color: var(--text-muted)" th:text="${chat.lastMessage}">Message preview...</small>
                        </div>
                    </div>
                </a>
            </div>
        </div>

        <!-- ================= CHAT AREA ================= -->
        <!-- Добавляем col-12 для мобильных -->
        <div class="col-12 col-md-8 col-lg-9 chat-column">

            <!-- NO CHAT SELECTED (Только на десктопе будет видно благодаря CSS) -->
            <div th:if="${activeConversation == null}" class="chat-area d-flex flex-column justify-content-center align-items-center">
                <i class="bi bi-chat-left-dots text-info opacity-25" style="font-size: 5rem;"></i>
                <h3 class="mt-3 fw-light text-muted">Select a chat</h3>
            </div>

            <!-- ACTIVE CHAT -->
            <div th:if="${activeConversation != null}" class="chat-area">
                <div class="chat-header">
                    <div class="d-flex align-items-center" style="min-width: 0;"> <!-- min-width fix for flex child -->

                        <!-- UPDATED: Кнопка НАЗАД (видна только на мобильном) -->
                        <a href="/chats" class="mobile-back-btn text-decoration-none">
                            <i class="bi bi-arrow-left"></i>
                        </a>

                        <a th:href="@{/profile/{username}(username=${activeConversation.targetUsername})}">
                            <img th:src="${activeConversation.conversationPicture}" class="avatar-img me-3" style="width: 40px; height: 40px;">
                        </a>
                        <div class="text-truncate">
                            <h6 class="mb-0 fw-bold text-white text-truncate" th:text="${activeConversation.targetUsername}">Username</h6>
                            <small class="text-info small">Active</small>
                        </div>
                    </div>
                    <a href="/watch/select-video" class="btn btn-outline-info btn-sm rounded-pill px-3 ms-2">
                        <i class="bi bi-play-fill"></i> <span class="watch-btn-text">Watch</span>
                    </a>
                </div>

                <div id="messageArea" class="messages-box">
                    <div th:each="msg : ${chatHistory}" class="message-container" th:classappend="${msg.senderUsername == username} ? 'message-sent' : 'message-received'">
                        <div class="msg-bubble">
                            <span th:text="${msg.content}">Content</span>
                            <span class="msg-time d-block text-end" th:text="${#temporals.format(msg.sentAt, 'HH:mm')}">12:00</span>
                        </div>
                    </div>
                </div>

                <div class="chat-footer">
                    <div class="input-group-custom">
                        <input type="text" id="messageInput" class="form-control chat-input" placeholder="Type a message..." autocomplete="off">
                        <button class="btn btn-link text-info p-0 ms-2" onclick="sendMessage()"><i class="bi bi-send-fill fs-4"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="currentConversationId" th:value="${activeConversation != null ? activeConversation.id : ''}">
<input type="hidden" id="currentUsername" th:value="${username}">

<!-- SCRIPTS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    var stompClient = null;
    var conversationId = document.getElementById("currentConversationId").value;
    var username = document.getElementById("currentUsername").value;
    var messageArea = document.getElementById("messageArea");
    var messageInput = document.getElementById("messageInput");

    document.addEventListener("DOMContentLoaded", function() {
        scrollToBottom();
        connect();

        // UPDATED: Фикс скролла при открытии клавиатуры на Android
        if(messageArea) {
            window.addEventListener('resize', function() {
                if(document.activeElement === messageInput) {
                    scrollToBottom();
                }
            });
        }

        if (messageInput) {
            messageInput.addEventListener("keypress", (e) => { if (e.key === "Enter") sendMessage(); });
            // Убираем автофокус на мобильных, чтобы клавиатура не прыгала сразу
            if(window.innerWidth > 768) {
                messageInput.focus();
            }
        }
    });

    // ... (Остальные JS функции connect, addNotificationToUI и т.д. остаются без изменений) ...

    function connect() {
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;
        stompClient.connect({}, function (frame) {
            if (conversationId) {
                stompClient.subscribe('/topic/conversation/' + conversationId, function (res) {
                    showIncomingMessage(JSON.parse(res.body));
                });
            }
            stompClient.subscribe('/user/queue/notifications', function (res) {
                addNotificationToUI(JSON.parse(res.body));
            });
        });
    }

    function addNotificationToUI(notification) {
       // ... (код из вашего предыдущего вопроса)
        if (conversationId && notification.conversationId == conversationId) return;
        var badge = document.getElementById("notificationBadge");
        if (badge) {
            var count = parseInt(badge.innerText) || 0;
            badge.innerText = count + 1;
            badge.style.display = "block";
        }
        // ... (остальной код уведомлений)
    }

    function sendMessage() {
        var content = messageInput.value.trim();
        if(content && stompClient) {
            stompClient.send("/app/conversation/" + conversationId + "/sendMessage", {}, JSON.stringify({content: content, conversationId: conversationId}));
            messageInput.value = '';
            messageInput.focus(); // Возвращаем фокус после отправки
        }
    }

    function showIncomingMessage(message) {
        if (!messageArea) return;
        var div = document.createElement('div');
        var isMe = (message.senderUsername === username);
        div.className = `message-container ${isMe ? 'message-sent' : 'message-received'}`;
        div.innerHTML = `<div class="msg-bubble"><span>${message.content}</span><span class="msg-time d-block text-end">${formatTime(message.sentAt)}</span></div>`;
        messageArea.appendChild(div);
        scrollToBottom();
    }

    function scrollToBottom() {
        if (messageArea) {
            messageArea.scrollTop = messageArea.scrollHeight;
        }
    }

    function formatTime(s) { return s ? new Date(s).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "Now"; }
</script>
</body>
</html>