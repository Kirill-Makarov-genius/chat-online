<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Chat Online</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        /* --- 1. GLOBAL LAYOUT LOCK --- */
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden; /* CRITICAL: Prevents the browser window from scrolling */
            background-color: #f0f2f5;
        }

        /* Force Bootstrap container to fill screen */
        .container-fluid {
            height: 100%;
            padding: 0;
        }

        .row.main-row {
            height: 100%;
            margin: 0; /* Remove Bootstrap negative margins */
        }

        /* --- 2. SIDEBAR (Left) --- */
        .sidebar {
            height: 100%;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #dee2e6;
            background-color: white;
            z-index: 1;
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            flex-shrink: 0; /* Never shrink sidebar header */
        }

        .chat-list {
            flex-grow: 1;
            overflow-y: auto; /* Independent scrolling */
            min-height: 0;    /* Firefox Flexbox fix */
        }

        /* --- 3. CHAT AREA (Right) --- */
        /* Target the column wrapper */
        .chat-column {
            height: 100%;
            padding: 0; /* Remove Bootstrap padding */
        }

        .chat-area {
            height: 100%;
            display: flex;
            flex-direction: column; /* Vertical Stack */
            background-color: #efeae2;
            position: relative;
        }

        /* --- 4. HEADER & FOOTER (Fixed) --- */
        .chat-header {
            height: 60px;
            flex-shrink: 0; /* CRITICAL: Never collapse */
            display: flex;
            align-items: center;
            background-color: white;
            border-bottom: 1px solid #dee2e6;
            padding: 0 20px;
        }

        .chat-footer {
            height: 70px;
            flex-shrink: 0; /* CRITICAL: Never collapse input area */
            display: flex;
            align-items: center;
            background-color: #f0f0f0;
            padding: 0 20px;
        }

        /* --- 5. SCROLLABLE MESSAGES (Middle) --- */
        .messages-box {
            flex-grow: 1;     /* Take all remaining height */
            overflow-y: auto; /* Scroll ONLY here */
            display: flex;
            flex-direction: column;
            padding: 20px;

            /* THE MAGIC FIX: Allows scrollbar to appear */
            min-height: 0;
        }

        /* Push messages to bottom if conversation is short */
        .messages-box > :first-child {
            margin-top: auto;
        }

        /* --- VISUAL STYLES --- */
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }

        .conversation-item { padding: 15px; border-bottom: 1px solid #f9f9f9; cursor: pointer; }
        .conversation-item:hover { background-color: #f5f5f5; }
        .conversation-item.active { background-color: #e7f1ff; border-left: 4px solid #0d6efd; }
        .avatar-img { width: 45px; height: 45px; object-fit: cover; border-radius: 50%; }

        .message-container { max-width: 70%; margin-bottom: 10px; display: flex; flex-direction: column; flex-shrink: 0; }
        .message-sent { align-self: flex-end; align-items: flex-end; }
        .message-received { align-self: flex-start; align-items: flex-start; }

        .msg-bubble { padding: 8px 12px; border-radius: 12px; position: relative; word-wrap: break-word; }
        .message-sent .msg-bubble { background-color: #d9fdd3; color: black; border-bottom-right-radius: 0; }
        .message-received .msg-bubble { background-color: white; color: black; border-bottom-left-radius: 0; }

        .sender-name { font-size: 0.75rem; color: #d63384; font-weight: 600; margin-bottom: 2px; margin-left: 5px;}
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row main-row">

        <!-- ================= SIDEBAR ================= -->
        <div class="col-md-4 col-lg-3 sidebar p-0">

            <!-- HEADER -->
            <div class="sidebar-header d-flex justify-content-between align-items-center">
                <a href="/" class="btn btn-light btn-sm rounded-circle text-decoration-none" title="Home">
                    <h4 class="mb-0 fw-bold text-primary">Chats</h4>
                </a>
                <div class="btn-group">
                    <a href="/profile" class="btn btn-light btn-sm rounded-circle" title="Settings">
                        <i class="bi bi-gear-fill text-secondary"></i>
                    </a>
                    <form th:action="@{/logout}" method="post" class="d-inline ms-1">
                        <button type="submit" class="btn btn-light btn-sm rounded-circle" title="Logout">
                            <i class="bi bi-box-arrow-right text-danger"></i>
                        </button>
                    </form>
                </div>
            </div>

            <!-- SEARCH (Visual Only) -->
            <div class="p-2 flex-shrink-0">
                <input type="text" class="form-control form-control-sm bg-light border-0" placeholder="Search or start new chat">
            </div>

            <!-- CONVERSATION LIST -->
            <div class="chat-list hide-scrollbar">
                <a th:each="chat : ${conversations}"
                   th:href="@{/chats/{id}(id=${chat.id})}"
                   th:attr="data-conversation-id=${chat.id}"
                   class="list-group-item list-group-item-action conversation-item"
                   th:classappend="${chat.active} ? 'active' : ''">

                    <div class="d-flex align-items-center">
                        <!-- Avatar -->
                        <div class="position-relative">
                            <img th:src="${chat.conversationPicture}" alt="Avatar" class="avatar-img">
                        </div>

                        <!-- Text Info -->
                        <div class="ms-3 overflow-hidden w-100">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 text-truncate" th:text="${chat.conversationName}">Name</h6>
                            </div>
                            <small class="text-muted text-truncate d-block last-message" th:text="${chat.lastMessage}">
                                Last message...
                            </small>
                        </div>
                    </div>
                </a>
            </div>
        </div>

        <!-- ================= MAIN CHAT AREA ================= -->
        <div class="col-md-8 col-lg-9 chat-column">

            <!-- SCENARIO A: NO CHAT SELECTED -->
            <div th:if="${activeConversation == null}" class="d-flex flex-column justify-content-center align-items-center h-100" style="background-color: #f0f2f5;">
                <div class="text-center p-5">
                    <i class="bi bi-chat-heart text-secondary" style="font-size: 5rem;"></i>
                    <h2 class="mt-4 text-secondary">Welcome, <span th:text="${username}">User</span>!</h2>
                    <p class="text-muted lead">Select a chat to start messaging.</p>
                </div>
            </div>

            <!-- SCENARIO B: ACTIVE CHAT -->
            <div th:if="${activeConversation != null}" class="chat-area">

                <!-- 1. CHAT HEADER -->
                <div class="chat-header shadow-sm">
                    <a th:href="@{/profile/users/{username}(username=${activeConversation.targetUsername})}"
                       class="d-flex align-items-center text-decoration-none text-dark">

                        <img th:src="${activeConversation.conversationPicture}"
                             class="rounded-circle me-2 border"
                             style="width: 40px; height: 40px; object-fit: cover;"
                             alt="Avatar">

                        <div>
                            <h6 class="mb-0" th:text="${activeConversation.targetUsername}">Name</h6>
                            <small class="text-muted">View Profile</small>
                        </div>
                    </a>
                </div>

                <!-- 2. MESSAGES FEED -->
                <div id="messageArea" class="messages-box hide-scrollbar">
                    <div th:each="msg : ${chatHistory}"
                         class="message-container"
                         th:classappend="${msg.senderUsername == username} ? 'message-sent' : 'message-received'">

                        <a th:if="${msg.senderUsername != username}"
                           th:href="@{/profile/users/{uid}(uid=${msg.senderUsername})}"
                           class="sender-name text-decoration-none"
                           th:text="${msg.senderUsername}">Name</a>

                        <div class="msg-bubble">
                            <span th:text="${msg.content}">Message Content</span>
                        </div>
                    </div>
                </div>

                <!-- 3. INPUT FOOTER (Fixed at bottom) -->
                <div class="chat-footer">
                    <div class="input-group">
                        <button class="btn btn-light text-secondary" type="button"><i class="bi bi-emoji-smile"></i></button>

                        <input type="text" id="messageInput" class="form-control border-0 bg-white" placeholder="Type a message..." autocomplete="off">

                        <button class="btn btn-primary" onclick="sendMessage()">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- HIDDEN DATA FOR JS -->
<input type="hidden" id="currentConversationId"
       th:value="${activeConversation != null ? activeConversation.getId() : ''}">
<input type="hidden" id="currentUsername" th:value="${username}">

<!-- SCRIPTS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    var stompClient = null;
    var conversationId = document.getElementById("currentConversationId").value;
    var username = document.getElementById("currentUsername").value;
    var messageArea = document.getElementById("messageArea");
    var messageInput = document.getElementById("messageInput");

    document.addEventListener("DOMContentLoaded", function() {
        scrollToBottom();

        if (conversationId) {
            connect();
        }

        if (messageInput) {
            messageInput.addEventListener("keypress", function(event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    sendMessage();
                }
            });
            // Focus input on load
            messageInput.focus();
        }
    });

    function connect() {
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        // stompClient.debug = null; // Uncomment to hide debug logs

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/conversation/' + conversationId, function (result) {
                showIncomingMessage(JSON.parse(result.body));
            });
        });
    }

    function sendMessage() {
        var content = messageInput.value.trim();
        if(content && stompClient) {
            var chatMessage = {
                content: content,
                conversationId: conversationId
            };
            stompClient.send("/app/conversation/" + conversationId + "/sendMessage", {}, JSON.stringify(chatMessage));
            messageInput.value = '';
            messageInput.focus();
        }
    }

    function showIncomingMessage(message) {
        if (!messageArea) return;

        var div = document.createElement('div');
        var isMe = (message.senderUsername === username);

        div.classList.add('message-container');
        div.classList.add(isMe ? 'message-sent' : 'message-received');

        // Build Name Link
        var nameHtml = '';
        if (!isMe) {
            nameHtml = `<a href="/profile/users/${message.senderUsername}" class="sender-name text-decoration-none">${message.senderUsername}</a>`;
        }

        div.innerHTML = `
            ${nameHtml}
            <div class="msg-bubble">
                <span>${message.content}</span>
            </div>
        `;

        messageArea.appendChild(div);
        scrollToBottom();
        updateSidebarPreview(message);
    }

    function scrollToBottom() {
        if (messageArea) {
            messageArea.scrollTop = messageArea.scrollHeight;
        }
    }

    function updateSidebarPreview(message) {
        var chatItem = document.querySelector(`[data-conversation-id="${message.conversationId}"]`);
        if (chatItem) {
            var preview = chatItem.querySelector('.last-message');
            if (preview) {
                var prefix = (message.senderUsername === username) ? "You: " : "";
                preview.innerText = prefix + message.content;
            }
            chatItem.parentElement.prepend(chatItem);
            chatItem.classList.add("fw-bold");
            setTimeout(() => chatItem.classList.remove("fw-bold"), 2000);
        }
    }
</script>

</body>
</html>