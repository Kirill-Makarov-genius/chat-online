<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Chat Online</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        /* --- 1. GLOBAL LAYOUT LOCK --- */
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
            background-color: #f0f2f5;
        }

        .container-fluid, .row.main-row {
            height: 100%;
            padding: 0;
            margin: 0;
        }

        /* --- 2. SIDEBAR (Left) --- */
        .sidebar {
            height: 100%;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #dee2e6;
            background-color: white;
            z-index: 1;
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            flex-shrink: 0;
        }

        .chat-list {
            flex-grow: 1;
            overflow-y: auto;
            min-height: 0;
        }

        /* --- 3. CHAT AREA (Right) --- */
        .chat-column {
            height: 100%;
            padding: 0;
        }

        .chat-area {
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: #efeae2;
            position: relative;
        }

        /* --- 4. HEADER & FOOTER (Fixed) --- */
        .chat-header {
            height: 60px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            background-color: white;
            border-bottom: 1px solid #dee2e6;
            padding: 0 20px;
        }

        .chat-footer {
            height: 70px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            background-color: #f0f0f0;
            padding: 0 20px;
        }

        /* --- 5. SCROLLABLE MESSAGES --- */
        .messages-box {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding: 20px;
            min-height: 0;
        }

        .messages-box > :first-child {
            margin-top: auto;
        }

        .msg-bubble {
            padding: 8px 12px;
            position: relative;
            word-wrap: break-word;
            min-width: 80px;
        }

        .msg-time {
            display: block;
            font-size: 0.65rem;
            margin-top: 4px;
            text-align: right;
            opacity: 0.7;
        }

        .message-sent .msg-time { color: #1f5c09; }
        .message-received .msg-time { color: #888; }

        /* --- VISUAL STYLES --- */
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }

        .conversation-item { padding: 15px; border-bottom: 1px solid #f9f9f9; cursor: pointer; }
        .conversation-item:hover { background-color: #f5f5f5; }
        .conversation-item.active { background-color: #e7f1ff; border-left: 4px solid #0d6efd; }
        .avatar-img { width: 45px; height: 45px; object-fit: cover; border-radius: 50%; }

        .message-container { max-width: 70%; margin-bottom: 10px; display: flex; flex-direction: column; flex-shrink: 0; }
        .message-sent { align-self: flex-end; align-items: flex-end; }
        .message-received { align-self: flex-start; align-items: flex-start; }

        .message-sent .msg-bubble { background-color: #d9fdd3; color: black; border-bottom-right-radius: 0; }
        .message-received .msg-bubble { background-color: white; color: black; border-bottom-left-radius: 0; }

        .sender-name { font-size: 0.75rem; color: #d63384; font-weight: 600; margin-bottom: 2px; margin-left: 5px;}

        /* Dropdown custom style */
        .notification-dropdown { width: 300px; max-height: 400px; overflow-y: auto; }
        .notification-item { white-space: normal; } /* Allow text wrap */
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row main-row">

        <!-- ================= SIDEBAR ================= -->
        <div class="col-md-4 col-lg-3 sidebar p-0">

            <!-- HEADER -->
            <div class="sidebar-header d-flex justify-content-between align-items-center">
                <a href="/chats" class="btn btn-light btn-sm rounded-circle text-decoration-none" title="Home">
                    <h4 class="mb-0 fw-bold text-primary">Chats</h4>
                </a>

                <div class="d-flex align-items-center">

                    <!-- === NEW: NOTIFICATION BUTTON === -->
                    <div class="dropdown me-1">
                        <button class="btn btn-light btn-sm rounded-circle position-relative" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-bell-fill text-secondary"></i>

                            <!-- Red Badge (Hidden if count is 0) -->
                            <span id="notificationBadge"
                                  class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                                  style="font-size: 0.6rem; display: none;">
                                0
                            </span>
                        </button>

                        <ul class="dropdown-menu dropdown-menu-end shadow p-0 notification-dropdown" id="notificationList">
                            <li><h6 class="dropdown-header">Notifications</h6></li>

                            <!-- Unread notifications would be loaded here from Controller if passed -->
                            <!-- Dynamic items will be added via JS -->

                            <!-- Empty State -->
                            <li id="no-notif-msg" class="text-center p-3 text-muted small">
                                No new notifications
                            </li>
                        </ul>
                    </div>
                    <!-- ================================== -->

                    <div class="btn-group">
                        <a href="/profile" class="btn btn-light btn-sm rounded-circle" title="Settings">
                            <i class="bi bi-gear-fill text-secondary"></i>
                        </a>
                        <form th:action="@{/logout}" method="post" class="d-inline ms-1">
                            <button type="submit" class="btn btn-light btn-sm rounded-circle" title="Logout">
                                <i class="bi bi-box-arrow-right text-danger"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- SEARCH -->
            <div class="p-2 flex-shrink-0">
                <form action="/chats/open" method="post" class="d-flex">
                    <input type="text" name="targetUsername" class="form-control form-control-sm bg-light border-0 me-1" placeholder="Find user (enter username)..." required>
                    <button type="submit" class="btn btn-sm btn-primary"><i class="bi bi-plus"></i></button>
                </form>
            </div>

            <!-- CONVERSATION LIST -->
            <div class="chat-list hide-scrollbar">
                <a th:each="chat : ${conversations}"
                   th:href="@{/chats/{id}(id=${chat.id})}"
                   th:attr="data-conversation-id=${chat.id}"
                   class="list-group-item list-group-item-action conversation-item"
                   th:classappend="${chat.active} ? 'active' : ''">

                    <div class="d-flex align-items-center">
                        <div class="position-relative">
                            <img th:src="${chat.conversationPicture}" alt="Avatar" class="avatar-img">
                        </div>
                        <div class="ms-3 overflow-hidden w-100">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 text-truncate" th:text="${chat.conversationName}">Name</h6>
                            </div>
                            <small class="text-muted text-truncate d-block last-message" th:text="${chat.lastMessage}">
                                Last message...
                            </small>
                        </div>
                    </div>
                </a>
            </div>
        </div>

        <!-- ================= MAIN CHAT AREA ================= -->
        <div class="col-md-8 col-lg-9 chat-column">

            <!-- SCENARIO A: NO CHAT SELECTED -->
            <div th:if="${activeConversation == null}" class="d-flex flex-column justify-content-center align-items-center h-100" style="background-color: #f0f2f5;">
                <div class="text-center p-5">
                    <i class="bi bi-chat-heart text-secondary" style="font-size: 5rem;"></i>
                    <h2 class="mt-4 text-secondary">Welcome, <span th:text="${username}">User</span>!</h2>
                    <p class="text-muted lead">Select a chat to start messaging.</p>
                </div>
            </div>

            <!-- SCENARIO B: ACTIVE CHAT -->
            <div th:if="${activeConversation != null}" class="chat-area">
                <div class="chat-header shadow-sm">
                    <a th:href="@{/profile/users/{username}(username=${activeConversation.targetUsername})}"
                       class="d-flex align-items-center text-decoration-none text-dark">
                        <img th:src="${activeConversation.conversationPicture}" class="rounded-circle me-2 border" style="width: 40px; height: 40px; object-fit: cover;" alt="Avatar">
                        <div>
                            <h6 class="mb-0" th:text="${activeConversation.targetUsername}">Name</h6>
                            <small class="text-muted">View Profile</small>
                        </div>
                    </a>
                </div>

                <div id="messageArea" class="messages-box hide-scrollbar">
                    <div th:each="msg : ${chatHistory}"
                         class="message-container"
                         th:classappend="${msg.senderUsername == username} ? 'message-sent' : 'message-received'">
                        <a th:if="${msg.senderUsername != username}"
                           th:href="@{/profile/users/{uid}(uid=${msg.senderUsername})}"
                           class="sender-name text-decoration-none" th:text="${msg.senderUsername}">Name</a>
                        <div class="msg-bubble">
                            <span th:text="${msg.content}">Message Content</span>
                            <span class="msg-time" th:text="${#temporals.format(msg.sentAt, 'HH:mm')}">12:00</span>
                        </div>
                    </div>
                </div>

                <div class="chat-footer">
                    <div class="input-group">
                        <button class="btn btn-light text-secondary" type="button"><i class="bi bi-emoji-smile"></i></button>
                        <input type="text" id="messageInput" class="form-control border-0 bg-white" placeholder="Type a message..." autocomplete="off">
                        <button class="btn btn-primary" onclick="sendMessage()"><i class="bi bi-send-fill"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- HIDDEN DATA -->
<input type="hidden" id="currentConversationId" th:value="${activeConversation != null ? activeConversation.id : ''}">
<input type="hidden" id="currentUsername" th:value="${username}">

<!-- SCRIPTS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    var stompClient = null;
    var conversationId = document.getElementById("currentConversationId").value;
    var username = document.getElementById("currentUsername").value;
    var messageArea = document.getElementById("messageArea");
    var messageInput = document.getElementById("messageInput");
    var currentPage = 0;
    var isLoading = false;

    document.addEventListener("DOMContentLoaded", function() {
        scrollToBottom();

        // Always connect to listen for notifications
        connect();

        if (messageInput) {
            messageInput.addEventListener("keypress", function(event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    sendMessage();
                }
            });
            messageInput.focus();
        }

        if (messageArea) {
            messageArea.addEventListener("scroll", function() {
                if (messageArea.scrollTop === 0) loadOlderMessages();
            });
        }
    });

    function connect() {
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);

            // 1. Subscribe to Chat (If active)
            if (conversationId) {
                stompClient.subscribe('/topic/conversation/' + conversationId, function (result) {
                    showIncomingMessage(JSON.parse(result.body));
                });
            }

            // 2. Subscribe to Notifications (Global)
            stompClient.subscribe('/user/queue/notifications', function (result) {
                addNotificationToUI(JSON.parse(result.body));
            });
        });
    }

    // --- NEW: Handle Notification UI ---
    function addNotificationToUI(notif) {
        // If I am currently in the chat sending the notification, ignore it
        if (conversationId && conversationId == notif.conversationId) return;

        var list = document.getElementById("notificationList");
        var badge = document.getElementById("notificationBadge");
        var noMsg = document.getElementById("no-notif-msg");

        if (noMsg) noMsg.style.display = 'none';

        var li = document.createElement("li");
        li.innerHTML = `
            <a class="dropdown-item d-flex align-items-start p-2 border-bottom notification-item" href="/chats/${notif.conversationId}">
                <div class="flex-grow-1">
                    <p class="mb-0 small fw-bold">${notif.senderUsername}: ${notif.content.substring(0, 20)}...</p>
                    <small class="text-muted" style="font-size: 0.65rem;">Just now</small>
                </div>
                <span class="badge bg-primary rounded-pill p-1" style="font-size: 0.5rem;">‚óè</span>
            </a>
        `;

        // Insert after header
        list.insertBefore(li, list.children[1]);

        // Update Badge Count
        if (badge) {
            var count = parseInt(badge.innerText) || 0;
            badge.innerText = count + 1;
            badge.style.display = 'block'; // Show badge
        }
    }

    function sendMessage() {
        var content = messageInput.value.trim();
        if(content && stompClient) {
            var chatMessage = {
                content: content,
                conversationId: conversationId
            };
            stompClient.send("/app/conversation/" + conversationId + "/sendMessage", {}, JSON.stringify(chatMessage));
            messageInput.value = '';
            messageInput.focus();
        }
    }

    function showIncomingMessage(message) {
        if (!messageArea) return;
        var div = document.createElement('div');
        var isMe = (message.senderUsername === username);
        div.classList.add('message-container');
        div.classList.add(isMe ? 'message-sent' : 'message-received');
        var nameHtml = !isMe ? `<a href="/profile/users/${message.senderUsername}" class="sender-name text-decoration-none">${message.senderUsername}</a>` : '';
        var timeString = formatTime(message.sentAt);

        div.innerHTML = `
            ${nameHtml}
            <div class="msg-bubble">
                <span>${message.content}</span>
                <span class="msg-time">${timeString}</span>
            </div>
        `;
        messageArea.appendChild(div);
        scrollToBottom();
        updateSidebarPreview(message);
    }

    function scrollToBottom() {
        if (messageArea) {
            messageArea.scrollTop = messageArea.scrollHeight;
        }
    }

    function updateSidebarPreview(message) {
        var chatItem = document.querySelector(`[data-conversation-id="${message.conversationId}"]`);
        if (chatItem) {
            var preview = chatItem.querySelector('.last-message');
            if (preview) {
                var prefix = (message.senderUsername === username) ? "You: " : "";
                preview.innerText = prefix + message.content;
            }
            chatItem.parentElement.prepend(chatItem);
            chatItem.classList.add("fw-bold");
            setTimeout(() => chatItem.classList.remove("fw-bold"), 2000);
        }
    }

    function loadOlderMessages() {
        if (isLoading) return;
        isLoading = true;
        currentPage++;
        var oldScrollHeight = messageArea.scrollHeight;

        // Note: Your controller has mapped this to "/chats/api/{id}/history" due to Class level mapping
        fetch(`api/${conversationId}/history?page=${currentPage}`)
            .then(response => response.json())
            .then(messages => {
                if (messages.length === 0) {
                    isLoading = false;
                    return;
                }
                for (var i = messages.length - 1; i >= 0; i--) {
                    prependMessage(messages[i]);
                }
                messageArea.scrollTop = messageArea.scrollHeight - oldScrollHeight;
                isLoading = false;
            })
            .catch(err => {
                isLoading = false;
                currentPage--;
            });
    }

    function prependMessage(message) {
        var div = document.createElement('div');
        var isMe = (message.senderUsername === username);
        div.classList.add('message-container');
        div.classList.add(isMe ? 'message-sent' : 'message-received');
        var nameHtml = !isMe ? `<a href="/profile/users/${message.senderUsername}" class="sender-name text-decoration-none">${message.senderUsername}</a>` : '';
        var timeString = formatTime(message.sentAt);

        div.innerHTML = `
            ${nameHtml}
            <div class="msg-bubble">
                <span>${message.content}</span>
                <span class="msg-time">${timeString}</span>
            </div>
        `;
        messageArea.insertBefore(div, messageArea.firstChild);
    }

    function formatTime(dateString) {
        if (!dateString) return now();
        var date = new Date(dateString);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function now() {
        var date = new Date();
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
</script>

</body>
</html>