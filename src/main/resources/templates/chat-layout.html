<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>My Chat App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chat-list { height: 80vh; overflow-y: auto; border-right: 1px solid #ddd; }
        .chat-box { height: 70vh; overflow-y: auto; background: #f8f9fa; padding: 15px; }
        .conversation-item:hover { background-color: #f1f1f1; cursor: pointer; }
        .conversation-item.active { background-color: #0d6efd; color: white; }
        .message-sent { text-align: right; }
        .message-sent .msg-bubble { background-color: #0d6efd; color: white; }
        .message-received { text-align: left; }
        .message-received .msg-bubble { background-color: #e9ecef; color: black; }
        .msg-bubble { display: inline-block; padding: 10px; border-radius: 15px; margin-bottom: 5px; max-width: 70%; }
    </style>
</head>
<body>

<div class="container-fluid mt-4">
    <div class="row">
        
        <!-- SIDEBAR: List of Conversations -->
        <div class="col-md-3 chat-list">
            <h4 class="mb-3">Messages</h4>
            <div class="list-group">
                <!-- Iterate over conversations -->
                <a th:each="chat : ${conversations}"
                   th:href="@{/chats/{id}(id=${chat.id})}"
                   class="list-group-item list-group-item-action conversation-item"
                   th:classappend="${chat.active} ? 'active' : ''">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1" th:text="${chat.conversationName}">User Name</h6>
                    </div>
                    <small th:text="${chat.lastMessage}">Last message...</small>
                </a>
            </div>
        </div>

        <!-- MAIN AREA: Chat Box -->
        <div class="col-md-9">
            
            <!-- Welcome Screen (If no chat selected) -->
            <div th:if="${activeConversationId == null}" class="d-flex align-items-center justify-content-center" style="height: 80vh;">
                <div class="text-center text-muted">
                    <h3>Welcome to Chat!</h3>
                    <p>Select a conversation from the left to start messaging.</p>
                </div>
            </div>

            <!-- Active Chat Interface -->
            <div th:if="${activeConversationId != null}">
                <div class="card">
                    <div class="card-header">Chat Room #<span th:text="${activeConversationId}"></span></div>
                    
                    <!-- Messages Area -->
                    <div id="messageArea" class="chat-box">
                        <!-- Loop through history -->
                        <div th:each="msg : ${chatHistory}" 
                             th:class="${msg.senderUsername == username} ? 'message-sent' : 'message-received'">
                            <div class="msg-bubble">
                                <span th:text="${msg.content}">Message Content</span>
                            </div>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="card-footer">
                        <div class="input-group">
                            <input type="text" id="messageInput" class="form-control" placeholder="Type a message...">
                            <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</div>

<!-- DATA FOR JAVASCRIPT (Hidden Inputs) -->
<input type="hidden" id="currentConversationId" th:value="${activeConversationId}">
<input type="hidden" id="currentUsername" th:value="${username}">

<!-- SCRIPTS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
    var stompClient = null;
    var conversationId = document.getElementById("currentConversationId").value;
    var username = document.getElementById("currentUsername").value;

    // Only connect if a conversation is selected
    if (conversationId) {
        connect();
    }

    function connect() {
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function () {
            // Subscribe to this specific conversation topic
            stompClient.subscribe('/topic/conversation/' + conversationId, function (result) {
                showIncomingMessage(JSON.parse(result.body));
            });
        });
    }

    function sendMessage() {
        var content = document.getElementById("messageInput").value;
        if(content && stompClient) {
            var chatMessage = {
                content: content,
                conversationId: conversationId
            };
            stompClient.send("/app/chat/" + conversationId + "/sendMessage", {}, JSON.stringify(chatMessage));
            document.getElementById("messageInput").value = '';
        }
    }

    function showIncomingMessage(message) {
        var messageArea = document.getElementById("messageArea");
        
        // Create HTML element
        var div = document.createElement('div');
        div.className = (message.senderUsername === username) ? 'message-sent' : 'message-received';
        div.innerHTML = `<div class="msg-bubble">${message.content}</div>`;
        
        messageArea.appendChild(div);
        messageArea.scrollTop = messageArea.scrollHeight; // Scroll to bottom
    }
</script>

</body>
</html>