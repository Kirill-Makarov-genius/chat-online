<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<!-- 1. Use the Head Fragment -->
<head th:replace="~{fragments/head :: common-head('Messenger', '/css/pages/chat.css')}"></head>


<body>

<div class="container-fluid p-0 m-0 overflow-hidden">
    <div class="row main-row g-0">

        <!-- 2. Use the Sidebar Fragment -->
        <div th:replace="~{fragments/sidebar :: sidebar-panel}"></div>

        <!-- ================= CHAT AREA ================= -->
        <div class="col-md-8 col-lg-9 chat-column">

            <!-- State A: NO CHAT SELECTED -->
            <div th:if="${activeConversation == null}" class="chat-area d-flex flex-column justify-content-center align-items-center">
                <i class="bi bi-chat-left-dots text-info opacity-25" style="font-size: 5rem;"></i>
                <h3 class="mt-3 fw-light text-muted">Select a chat to begin</h3>
            </div>

            <!-- State B: ACTIVE CHAT -->
            <div th:if="${activeConversation != null}" class="chat-area">
                <div class="chat-header">
                    <div class="d-flex align-items-center">
                        <a th:href="@{/profile/users/{username}(username=${activeConversation.targetUsername})}">
                            <img th:src="${activeConversation.conversationPicture}" class="avatar-img me-3" style="width: 42px; height: 42px;">
                        </a>
                        <div>
                            <h6 class="mb-0 fw-bold text-white" th:text="${activeConversation.targetUsername}">Username</h6>
                            <small class="text-info small">Active Now</small>
                        </div>
                    </div>
                    <a href="/watch/select-video" class="btn btn-outline-info btn-sm rounded-pill px-4">
                        <i class="bi bi-play-fill"></i> Watch Together
                    </a>
                </div>

                <div id="messageArea" class="messages-box">
                    <div th:each="msg : ${chatHistory}" class="message-container" th:classappend="${msg.senderUsername == username} ? 'message-sent' : 'message-received'">
                        <div class="msg-bubble">
                            <span th:text="${msg.content}">Content</span>
                            <span class="msg-time d-block text-end" th:text="${#temporals.format(msg.sentAt, 'HH:mm')}">12:00</span>
                        </div>
                    </div>
                </div>

                <div class="chat-footer">
                    <div class="input-group-custom">
                        <input type="text" id="messageInput" class="form-control chat-input" placeholder="Type a message..." autocomplete="off">
                        <button class="btn btn-link text-info p-0 ms-2" onclick="sendMessage()"><i class="bi bi-send-fill fs-4"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="currentConversationId" th:value="${activeConversation != null ? activeConversation.id : ''}">
<input type="hidden" id="currentUsername" th:value="${username}">

<!-- SCRIPTS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


<div th:replace="~{fragments/notifications :: global-notifications}"></div>

<script th:inline="javascript">
    /* --- 1. –ü–ï–†–ï–ú–ï–ù–ù–´–ï --- */
    // –≠—Ç–æ—Ç —Ñ–ª–∞–≥ –≥–æ–≤–æ—Ä–∏—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ–º—É —Å–∫—Ä–∏–ø—Ç—É: "–ù–µ –ø–æ–¥–∫–ª—é—á–∞–π—Å—è —Å–∞–º, —è —Å–¥–µ–ª–∞—é —ç—Ç–æ –≤—Ä—É—á–Ω—É—é"
    const manualConnection = true;

    var stompClient = null; // –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω –≤–Ω—É—Ç—Ä–∏ callback
    var conversationId = document.getElementById("currentConversationId").value;
    var username = document.getElementById("currentUsername").value;
    var messageArea = document.getElementById("messageArea");
    var messageInput = document.getElementById("messageInput");

    /* --- 2. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø --- */
    document.addEventListener("DOMContentLoaded", function() {
        scrollToBottom();

        // –í–ú–ï–°–¢–û connect() –≤—ã–∑—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
        connectGlobalSocket(function(client) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª–∏–µ–Ω—Ç–∞ –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
            stompClient = client;

            // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –¢–ï–ö–£–©–ò–ô —á–∞—Ç
            if (conversationId) {
                console.log("üí¨ Subscribing to conversation: " + conversationId);
                client.subscribe('/topic/conversation/' + conversationId, function (res) {
                    showIncomingMessage(JSON.parse(res.body));
                });
            }
        });

        if (messageInput) {
            messageInput.addEventListener("keypress", (e) => { if (e.key === "Enter") sendMessage(); });
            messageInput.focus();
        }
    });

    /* --- 3. –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–ô --- */
    function sendMessage() {
        var content = messageInput.value.trim();
        if(content && stompClient) {
            stompClient.send("/app/conversation/" + conversationId + "/sendMessage", {}, JSON.stringify({content: content, conversationId: conversationId}));
            messageInput.value = '';
        }
    }

    /* --- 4. –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–ô --- */
    function showIncomingMessage(message) {
        if (!messageArea) return;
        var div = document.createElement('div');
        var isMe = (message.senderUsername === username);
        div.className = `message-container ${isMe ? 'message-sent' : 'message-received'}`;
        div.innerHTML = `<div class="msg-bubble"><span>${message.content}</span><span class="msg-time d-block text-end">${formatTime(message.sentAt)}</span></div>`;
        messageArea.appendChild(div);
        scrollToBottom();
    }

    function scrollToBottom() { if (messageArea) messageArea.scrollTop = messageArea.scrollHeight; }
    function formatTime(s) { return s ? new Date(s).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "Now"; }

</script>
</body>
</html>