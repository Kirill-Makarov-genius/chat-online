<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${room.name} + ' | Chat Online'">Watch Room</title>

    <!-- Modern UI Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Video.js & Mux.js (The MKV Engine) -->
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mux.js/6.3.0/mux.min.js"></script>

    <!-- WebSocket Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <style>
        :root {
            --bg-body: #080c14;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent: #38bdf8;
            --accent-glow: rgba(56, 189, 248, 0.4);
        }

        body {
            background: radial-gradient(circle at top right, #1e293b, var(--bg-body));
            background-attachment: fixed;
            color: #f1f5f9;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .badge-live {
            background: #ef4444;
            font-weight: 700;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .video-wrapper {
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--glass-border);
        }

        /* Video.js custom sizing */
        .video-js {
            width: 100% !important;
            height: auto;
            aspect-ratio: 16 / 9;
        }

        .sidebar-title { font-size: 0.9rem; text-transform: uppercase; color: var(--accent); font-weight: 700; }
        .status-dot { height: 8px; width: 8px; background: #10b981; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .btn-accent { background: var(--accent); color: #000; font-weight: 600; border-radius: 12px; }
        .copy-box { background: rgba(0,0,0,0.3); border: 1px dashed var(--glass-border); border-radius: 12px; padding: 8px 15px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container-fluid px-4 py-4">
    <!-- Header -->
    <div class="glass-card p-3 mb-4 d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
            <a href="/watch/select-video" class="btn btn-link text-white me-3"><i class="bi bi-chevron-left"></i></a>
            <div>
                <h4 class="mb-0 fw-bold" th:text="${room.name}">Room Name</h4>
                <p class="text-muted mb-0 small"><i class="bi bi-file-earmark-play me-1"></i> <span th:text="${room.fileName}">video.mp4</span></p>
            </div>
        </div>
        <div class="d-flex align-items-center gap-3">
            <span class="badge badge-live px-3 py-2 rounded-pill">LIVE</span>
            <div class="copy-box" onclick="copyRoomId()" id="roomLinkBox">
                <span class="small me-2">ID:</span>
                <span class="fw-bold text-info" th:text="${room.id}" id="roomIdText">ID</span>
                <i class="bi bi-copy ms-2"></i>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Player -->
        <div class="col-xl-9 col-lg-8 mb-4">
            <!-- Replace your video container with this -->
            <div id="videoContainer" class="video-wrapper shadow-lg">

                <!-- Loading Screen -->
                <div th:if="${room.status.name() == 'PROCESSING'}" id="loadingScreen"
                     class="text-center p-5 bg-dark rounded-4 border border-secondary">
                    <div class="spinner-border text-info mb-3" role="status"></div>
                    <h4>Converting Video for your Room...</h4>
                    <p class="text-muted">This usually takes 1-3 minutes for large files.</p>
                </div>

                <!-- Video Player (Hidden if processing) -->
                <video th:if="${room.status.name() == 'READY'}" id="mainPlayer"
                       class="video-js vjs-default-skin vjs-big-play-centered w-100" controls preload="auto">
                    <source th:src="@{/api/local-video/{id}(id=${room.id})}" type="video/mp4">
                </video>
            </div>

            <div class="mt-4 p-4 glass-card d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-1 fw-bold">Synchronized Playback</h5>
                    <p class="mb-0 text-muted small">Actions are synced via WebSockets.</p>
                </div>
                <div class="text-end">
                    <p class="mb-0 small text-muted">Host</p>
                    <p class="mb-0 fw-bold text-info" th:text="${room.creatorName}">Host Name</p>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-xl-3 col-lg-4">
            <div class="glass-card p-4 h-100">
                <h6 class="sidebar-title mb-4">Participants</h6>
                <div class="participant-item d-flex align-items-center mb-3">
                    <div class="status-dot"></div>
                    <span class="fw-bold" th:text="${room.creatorName}">Host</span>
                </div>
                <hr class="border-secondary">
                <h6 class="sidebar-title mb-3">Invite</h6>
                <button class="btn btn-accent w-100 py-3" onclick="copyRoomId()">Invite Friends <i class="bi bi-people-fill ms-2"></i></button>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /* --- 1. Variables --- */
    const roomId = [[${room.id}]];
    const fileId = [[${room.fileId}]];
    const currentUser = [[${#authentication.name}]];
    const initialState = {
        time: [[${room.currentTime}]],
        isPlaying: [[${room.isPlaying}]]
    };
    let isRemoteAction = false;

    const player = videojs('mainPlayer', {
        autoplay: false,
        controls: true,
        preload: 'auto',
        fluid: true // Makes video responsive
    });

    /* --- 3. WebSocket Connection --- */
    const socket = new SockJS('/ws');
    const stompClient = Stomp.over(socket);
    stompClient.debug = null;

    stompClient.connect({}, () => {
        console.log("WebSocket Connected to room: " + roomId);
        stompClient.subscribe('/topic/video/' + roomId, (message) => {
            const signal = JSON.parse(message.body);
            if (signal.sender !== currentUser) {
                handleRemoteSignal(signal);
            }
        });
    });

    /* --- 4. Synchronization Logic --- */

    // Seek to initial time once video metadata is ready
    player.ready(() => {
        player.one('loadedmetadata', () => {
            player.currentTime(initialState.time);
            if (initialState.isPlaying) {
                player.play().catch(() => console.log("Autoplay blocked by browser."));
            }
        });
    });

    // Local Event Listeners (Send signals to others)
    player.on('play', () => {
        if (!isRemoteAction) sendSignal("PLAY", player.currentTime());
    });

    player.on('pause', () => {
        if (!isRemoteAction) sendSignal("PAUSE", player.currentTime());
    });

    player.on('seeked', () => {
        if (!isRemoteAction) sendSignal("SEEK", player.currentTime());
    });

    function sendSignal(action, time) {
        const payload = {
            action: action,
            currentTime: time,
            fileId: fileId,
            sender: currentUser
        };
        stompClient.send("/app/video.sync/" + roomId, {}, JSON.stringify(payload));
    }

    function handleRemoteSignal(signal) {
        isRemoteAction = true; // Block local listeners from triggering

        if (signal.action === "STATUS_UPDATE") {
            location.reload();
        }
        if (signal.action === "PLAY") {
            player.currentTime(signal.currentTime);
            player.play();
        } else if (signal.action === "PAUSE") {
            player.pause();
        } else if (signal.action === "SEEK") {
            player.currentTime(signal.currentTime);
        }

        // Delay resetting the flag to allow Video.js to finish state changes
        setTimeout(() => { isRemoteAction = false; }, 600);
    }

    /* --- 5. Utilities --- */
    function copyRoomId() {
        const idText = document.getElementById('roomIdText').innerText;
        navigator.clipboard.writeText(idText);
        const box = document.getElementById('roomLinkBox');
        const originalHtml = box.innerHTML;
        box.innerHTML = '<span class="text-success small fw-bold">Copied! <i class="bi bi-check-lg"></i></span>';
        setTimeout(() => { box.innerHTML = originalHtml; }, 2000);
    }
</script>
</body>
</html>