<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/head :: common-head(${room.name})}"></head>

<style>
    /* Aspect Ratio for Player */
    .video-wrapper {
        background: #000;
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid var(--glass-border);
        box-shadow: 0 20px 50px rgba(0,0,0,0.6);
    }

    .video-js {
        width: 100% !important;
        height: auto;
        aspect-ratio: 16 / 9;
    }

    /* Sidebar Participant List */
    .participant-list {
        max-height: 300px;
        overflow-y: auto;
    }

    /* THEATER MODE: Mobile Landscape Logic */
    @media (orientation: landscape) and (max-height: 500px) {
        .header-main-card, .sidebar-section, .sync-info-card { display: none !important; }
        .video-column { margin-bottom: 0 !important; width: 100% !important; }
        .video-wrapper { border-radius: 0; border: none; }
        .container-fluid { padding: 0 !important; }
    }

    /* Mobile Portrait Tweaks */
    @media (max-width: 768px) {
        .header-main-card h4 { font-size: 1.1rem; }
        .copy-box { font-size: 0.8rem; padding: 6px 12px; }
    }
</style>

<body>

<div class="container-fluid px-3 px-md-4 py-3 py-md-4">

    <!-- HEADER: Room Dashboard -->
    <div class="glass-card header-main-card p-3 mb-3 mb-md-4 d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
            <a th:href="@{/watch/manage}" class="btn btn-link text-white ps-0 pe-2 pe-md-3">
                <i class="bi bi-chevron-left fs-4"></i>
            </a>
            <div class="text-truncate" style="max-width: 180px; @media(min-width: 768px){max-width: 500px;}">
                <h4 class="mb-0 fw-bold text-truncate" th:text="${room.name}">Room Name</h4>
                <p class="mb-0 small  text-truncate">
                    <i class="bi bi-file-earmark-play me-1"></i>
                    <span th:text="${room.fileName}">video.mp4</span>
                </p>
            </div>
        </div>

        <div class="d-flex align-items-center gap-2">
            <span class="badge badge-live px-3 py-2 rounded-pill d-none d-sm-inline-block">LIVE</span>
            <div class="copy-box d-flex align-items-center glass-card border-glass px-3 py-2"
                 style="cursor: pointer; background: rgba(0,0,0,0.2);" onclick="copyRoomId()" id="roomLinkBox">
                <span class="fw-bold text-accent me-2" th:text="${room.id}" id="roomIdText">ID</span>
                <i class="bi bi-copy"></i>
            </div>
        </div>
    </div>

    <div class="row g-3 g-md-4">
        <!-- PLAYER COLUMN -->
        <div class="col-12 col-lg-8 col-xl-9 video-column">
            <div class="video-wrapper shadow-lg">
                <!-- Video.js Player -->
                <video id="mainPlayer" class="video-js vjs-default-skin vjs-big-play-centered w-100"
                       controls preload="auto">
                    <source th:src="@{/api/video/{id}(id=${room.fileId})}" type="video/mp4">
                </video>
            </div>

            <!-- SYNC INFO CARD -->
            <div class="mt-3 mt-md-4 p-3 p-md-4 glass-card d-flex justify-content-between align-items-center sync-info-card">
                <div>
                    <h6 class="mb-1 fw-bold text-accent">Synchronized Playback</h6>
                    <p class="mb-0  small d-none d-md-block">Your actions are broadcasted to all participants via WebSockets.</p>
                </div>
                <div class="text-end">
                    <p class="mb-0 small ">Host</p>
                    <p class="mb-0 fw-bold" th:text="${room.creatorName}">Host Name</p>
                </div>
            </div>
        </div>

        <!-- SIDEBAR: Participants & Invite -->
        <div class="col-12 col-lg-4 col-xl-3 sidebar-section">
            <div class="glass-card p-4 h-100">
                <h6 class="text-uppercase small fw-bold text-accent mb-4" style="letter-spacing: 1px;">Participants</h6>

                <div class="participant-list mb-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="rounded-circle bg-success me-3" style="width: 10px; height: 10px; box-shadow: 0 0 10px #10b981;"></div>
                        <div>
                            <span class="fw-bold d-block" th:text="${room.creatorName}">User</span>
                            <small class="">Currently Watching</small>
                        </div>
                    </div>
                    <!-- Future dynamic participants go here -->
                </div>

                <hr class="border-glass my-4">

                <h6 class="text-uppercase small fw-bold text-accent mb-3" style="letter-spacing: 1px;">Invite Friends</h6>
                <p class="small  mb-4">Anyone with the Room ID can join your session instantly.</p>

                <button class="btn-accent w-100 py-3" onclick="copyRoomId()">
                    Copy Link ID <i class="bi bi-link-45deg ms-1"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Load External Video.js Assets -->
<link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<!-- WebSocket & Logic -->
<script th:inline="javascript">
    /* =========================================
       1. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–ï–†–ï–ú–ï–ù–ù–´–•
       ========================================= */
    const roomId = [[${room.id}]];
    const fileId = [[${room.fileId}]];
    const currentUser = [[${#authentication.name}]];
    const initialState = {
        time: [[${room.currentTime}]],
        isPlaying: [[${room.isPlaying}]]
    };

    // –§–ª–∞–≥: –µ—Å–ª–∏ true, –∑–Ω–∞—á–∏—Ç –º—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–∏–≥–Ω–∞–ª –æ—Ç –¥—Ä—É–≥–æ–≥–æ —é–∑–µ—Ä–∞
    // –∏ –Ω–µ –¥–æ–ª–∂–Ω—ã –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –µ–≥–æ –æ–±—Ä–∞—Ç–Ω–æ.
    let isRemoteAction = false;

    /* =========================================
       2. –ù–ê–°–¢–†–û–ô–ö–ê –ü–õ–ï–ï–†–ê VIDEO.JS
       ========================================= */
    const player = videojs('mainPlayer', {
        fluid: true,
        responsive: true,
        playbackRates: [0.5, 1, 1.5, 2]
    });

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    player.ready(() => {
        player.one('loadedmetadata', () => {
            if (initialState.time > 0) {
                player.currentTime(initialState.time);
            }
            if (initialState.isPlaying) {
                var promise = player.play();
                if (promise !== undefined) {
                    promise.catch(error => {
                        console.warn("Autoplay blocked by browser. User must interact first.");
                        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É "Click to Start" –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                    });
                }
            }
        });
    });

    /* =========================================
       3. WEBSOCKET –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï
       ========================================= */
    const socket = new SockJS('/ws');
    const stompClient = Stomp.over(socket);

    // –í–ö–õ–Æ–ß–ê–ï–ú –õ–û–ì–ò (—á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –≤ –∫–æ–Ω—Å–æ–ª–∏)
    stompClient.debug = function(str) {
        console.log(str);
    };

    stompClient.connect({}, () => {
        console.log("‚úÖ WebSocket Connected!");

        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª –∫–æ–º–Ω–∞—Ç—ã
        stompClient.subscribe('/topic/video/' + roomId, (message) => {
            const signal = JSON.parse(message.body);

            // –õ–æ–≥–∏—Ä—É–µ–º –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            console.log("üì© Received:", signal);

            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —á—É–∂–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            if (signal.sender !== currentUser) {
                handleRemoteSignal(signal);
            } else {
                console.log("‚úã Ignoring my own signal");
            }
        });
    }, (error) => {
        console.error("‚ùå STOMP Error:", error);
    });

    /* =========================================
       4. –õ–û–ì–ò–ö–ê –û–¢–ü–†–ê–í–ö–ò (–°–ª—É—à–∞–µ–º –ø–ª–µ–µ—Ä)
       ========================================= */

    // Play
    player.on('play', () => {
        if (!isRemoteAction) {
            console.log("üëâ Sending PLAY");
            sendSignal("PLAY", player.currentTime());
        }
    });

    // Pause
    player.on('pause', () => {
        if (!isRemoteAction) {
            console.log("üëâ Sending PAUSE");
            sendSignal("PAUSE", player.currentTime());
        }
    });

    // Seeked (–ü–µ—Ä–µ–º–æ—Ç–∫–∞)
    player.on('seeked', () => {
        if (!isRemoteAction) {
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç —á–∞—Å—Ç—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
            if(player.currentTime() > 0.1) {
                console.log("üëâ Sending SEEK");
                sendSignal("SEEK", player.currentTime());
            }
        }
    });

    function sendSignal(action, time) {
        if (stompClient && stompClient.connected) {
            const payload = {
                action: action,
                currentTime: time,
                fileId: fileId,
                sender: currentUser // <-- –í–ê–ñ–ù–û: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ Java DTO –µ—Å—Ç—å –ø–æ–ª–µ sender!
            };
            stompClient.send("/app/video.sync/" + roomId, {}, JSON.stringify(payload));
        } else {
            console.warn("‚ö†Ô∏è Cannot send signal: WebSocket disconnected");
        }
    }

    /* =========================================
       5. –õ–û–ì–ò–ö–ê –ü–û–õ–£–ß–ï–ù–ò–Ø (–£–ø—Ä–∞–≤–ª—è–µ–º –ø–ª–µ–µ—Ä–æ–º)
       ========================================= */
    function handleRemoteSignal(signal) {
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Å–≤–æ–∏—Ö —Å–æ–±—ã—Ç–∏–π
        isRemoteAction = true;
        console.log("‚öôÔ∏è Applying remote action:", signal.action);

        if (signal.action === "PLAY") {
            // –°–∏–Ω—Ö—Ä–æ–Ω –≤—Ä–µ–º–µ–Ω–∏, –µ—Å–ª–∏ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω > 0.5 —Å–µ–∫
            if (Math.abs(player.currentTime() - signal.currentTime) > 0.5) {
                player.currentTime(signal.currentTime);
            }
            player.play().catch(e => console.error("Remote play failed:", e));
        }
        else if (signal.action === "PAUSE") {
            player.pause();
            player.currentTime(signal.currentTime); // –ü—Ä–∏ –ø–∞—É–∑–µ –≤—Ä–µ–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ç–æ—á–Ω—ã–º
        }
        else if (signal.action === "SEEK") {
            player.currentTime(signal.currentTime);
        }

        // –°–Ω–∏–º–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É —á–µ—Ä–µ–∑ 500–º—Å
        setTimeout(() => {
            isRemoteAction = false;
        }, 500);
    }

    /* =========================================
       6. –£–¢–ò–õ–ò–¢–´ (–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏)
       ========================================= */
    function copyRoomId() {
        navigator.clipboard.writeText(roomId);
        const box = document.getElementById('roomLinkBox');
        if(box) {
            const originalHtml = box.innerHTML;
            box.innerHTML = '<span class="text-success small fw-bold">Copied!</span>';
            setTimeout(() => { box.innerHTML = originalHtml; }, 2000);
        }
    }
</script>

<!--<div th:replace="~{fragments/notifications :: global-notifications}"></div>-->
</body>
</html>