<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/head :: common-head(${room.name})}"></head>

<style>
    /* Aspect Ratio for Player */
    .video-wrapper {
        background: #000;
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid var(--glass-border);
        box-shadow: 0 20px 50px rgba(0,0,0,0.6);
    }

    .video-js {
        width: 100% !important;
        height: auto;
        aspect-ratio: 16 / 9;
    }

    /* Sidebar Participant List */
    .participant-list {
        max-height: 300px;
        overflow-y: auto;
    }

    /* THEATER MODE: Mobile Landscape Logic */
    @media (orientation: landscape) and (max-height: 500px) {
        .header-main-card, .sidebar-section, .sync-info-card { display: none !important; }
        .video-column { margin-bottom: 0 !important; width: 100% !important; }
        .video-wrapper { border-radius: 0; border: none; }
        .container-fluid { padding: 0 !important; }
    }

    /* Mobile Portrait Tweaks */
    @media (max-width: 768px) {
        .header-main-card h4 { font-size: 1.1rem; }
        .copy-box { font-size: 0.8rem; padding: 6px 12px; }
    }
</style>

<body>

<div class="container-fluid px-3 px-md-4 py-3 py-md-4">

    <!-- HEADER: Room Dashboard -->
    <div class="glass-card header-main-card p-3 mb-3 mb-md-4 d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
            <a th:href="@{/watch/manage}" class="btn btn-link text-white ps-0 pe-2 pe-md-3">
                <i class="bi bi-chevron-left fs-4"></i>
            </a>
            <div class="text-truncate" style="max-width: 180px; @media(min-width: 768px){max-width: 500px;}">
                <h4 class="mb-0 fw-bold text-truncate" th:text="${room.name}">Room Name</h4>
                <p class="mb-0 small  text-truncate">
                    <i class="bi bi-file-earmark-play me-1"></i>
                    <span th:text="${room.fileName}">video.mp4</span>
                </p>
            </div>
        </div>

        <div class="d-flex align-items-center gap-2">
            <span class="badge badge-live px-3 py-2 rounded-pill d-none d-sm-inline-block">LIVE</span>
            <div class="copy-box d-flex align-items-center glass-card border-glass px-3 py-2"
                 style="cursor: pointer; background: rgba(0,0,0,0.2);" onclick="copyRoomId()" id="roomLinkBox">
                <span class="fw-bold text-accent me-2" th:text="${room.id}" id="roomIdText">ID</span>
                <i class="bi bi-copy"></i>
            </div>
        </div>
    </div>

    <div class="row g-3 g-md-4">
        <!-- PLAYER COLUMN -->
        <div class="col-12 col-lg-8 col-xl-9 video-column">
            <div class="video-wrapper shadow-lg">
                <!-- Video.js Player -->
                <video id="mainPlayer" class="video-js vjs-default-skin vjs-big-play-centered w-100"
                       controls preload="auto">
                    <source th:src="@{/api/video/{id}(id=${room.fileId})}" type="video/mp4">
                </video>
            </div>

            <!-- SYNC INFO CARD -->
            <div class="mt-3 mt-md-4 p-3 p-md-4 glass-card d-flex justify-content-between align-items-center sync-info-card">
                <div>
                    <h6 class="mb-1 fw-bold text-accent">Synchronized Playback</h6>
                    <p class="mb-0  small d-none d-md-block">Your actions are broadcasted to all participants via WebSockets.</p>
                </div>
                <div class="text-end">
                    <p class="mb-0 small ">Host</p>
                    <p class="mb-0 fw-bold" th:text="${room.creatorName}">Host Name</p>
                </div>
            </div>
        </div>

        <!-- SIDEBAR: Participants & Invite -->
        <div class="col-12 col-lg-4 col-xl-3 sidebar-section">
            <div class="glass-card p-4 h-100">
                <h6 class="text-uppercase small fw-bold text-accent mb-4" style="letter-spacing: 1px;">Participants</h6>

                <div class="participant-list mb-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="rounded-circle bg-success me-3" style="width: 10px; height: 10px; box-shadow: 0 0 10px #10b981;"></div>
                        <div>
                            <span class="fw-bold d-block" th:text="${room.creatorName}">User</span>
                            <small class="">Currently Watching</small>
                        </div>
                    </div>
                    <!-- Future dynamic participants go here -->
                </div>

                <hr class="border-glass my-4">

                <h6 class="text-uppercase small fw-bold text-accent mb-3" style="letter-spacing: 1px;">Invite Friends</h6>
                <p class="small  mb-4">Anyone with the Room ID can join your session instantly.</p>

                <button class="btn-accent w-100 py-3" onclick="copyRoomId()">
                    Copy Link ID <i class="bi bi-link-45deg ms-1"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Load External Video.js Assets -->
<link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>

<!-- WebSocket & Logic -->
<script th:inline="javascript">
    /* --- 1. Variables from Thymeleaf --- */
    const roomId = [[${room.id}]];
    const fileId = [[${room.fileId}]];
    const currentUser = [[${#authentication.name}]];
    const initialState = {
        time: [[${room.currentTime}]],
        isPlaying: [[${room.isPlaying}]]
    };
    let isRemoteAction = false;

    /* --- 2. Initialize Video.js --- */
    const player = videojs('mainPlayer', {
        fluid: true,
        responsive: true,
        playbackRates: [0.5, 1, 1.5, 2]
    });

    /* --- 3. WebSocket Connection --- */
    const socket = new SockJS('/ws');
    const stompClient = Stomp.over(socket);
    stompClient.debug = null;

    stompClient.connect({}, () => {
        stompClient.subscribe('/topic/video/' + roomId, (message) => {
            const signal = JSON.parse(message.body);
            if (signal.sender !== currentUser) {
                handleRemoteSignal(signal);
            }
        });
    });

    /* --- 4. Synchronization Logic --- */

    player.ready(() => {
        player.one('loadedmetadata', () => {
            player.currentTime(initialState.time);
            if (initialState.isPlaying) {
                player.play().catch(() => console.log("User interaction required for play."));
            }
        });
    });

    // Local Event Emitters
    player.on('play', () => { if (!isRemoteAction) sendSignal("PLAY", player.currentTime()); });
    player.on('pause', () => { if (!isRemoteAction) sendSignal("PAUSE", player.currentTime()); });

    let lastSeek = 0;
    player.on('seeked', () => {
        if (!isRemoteAction) {
            const now = player.currentTime();
            if (Math.abs(now - lastSeek) > 1) {
                sendSignal("SEEK", now);
                lastSeek = now;
            }
        }
    });

    function sendSignal(action, time) {
        stompClient.send("/app/video.sync/" + roomId, {}, JSON.stringify({
            action: action, currentTime: time, fileId: fileId, sender: currentUser
        }));
    }

    function handleRemoteSignal(signal) {
        isRemoteAction = true;
        if (signal.action === "PLAY") {
            player.currentTime(signal.currentTime);
            player.play();
        } else if (signal.action === "PAUSE") {
            player.pause();
        } else if (signal.action === "SEEK") {
            player.currentTime(signal.currentTime);
        }
        setTimeout(() => { isRemoteAction = false; }, 600);
    }

    /* --- 5. Utilities --- */
    function copyRoomId() {
        navigator.clipboard.writeText(roomId);
        const box = document.getElementById('roomLinkBox');
        const originalHtml = box.innerHTML;
        box.innerHTML = '<span class="text-success small fw-bold">Copied! <i class="bi bi-check-lg"></i></span>';
        setTimeout(() => { box.innerHTML = originalHtml; }, 2000);
    }
</script>

<div th:replace="~{fragments/notifications :: global-notifications}"></div>
</body>
</html>